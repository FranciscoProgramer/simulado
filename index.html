<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Simulados</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #f0f0f0;
    }

    .title {
      font-size: 36px;
      color: #667eea;
      margin: 0 0 10px 0;
      font-weight: bold;
    }

    .subtitle {
      font-size: 18px;
      color: #666;
      margin: 0;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .tab {
      padding: 15px 25px;
      background: #f8f9fa;
      border: none;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: #667eea;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .form-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin: 0 0 20px 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-input, .form-select, .form-textarea {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
      font-family: monospace;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd8;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
    }

    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .student-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .student-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .student-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0 0 5px 0;
    }

    .student-class {
      color: #666;
      margin: 0 0 15px 0;
    }

    .student-score {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }

    .category-adequate {
      color: #007bff;
      background: #e3f2fd;
    }

    .category-intermediate {
      color: #ffc107;
      background: #fff8e1;
    }

    .category-defasagem {
      color: #dc3545;
      background: #ffebee;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      margin: 10px 0;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .list-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .list-item.adequate {
      background: #e3f2fd;
      border-color: #007bff;
    }

    .list-item.intermediate {
      background: #fff8e1;
      border-color: #ffc107;
    }

    .list-item.defasagem {
      background: #ffebee;
      border-color: #dc3545;
    }

    .student-info {
      flex: 1;
    }

    .student-results {
      text-align: right;
      font-weight: bold;
    }

    .celebration-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      border: 4px solid;
      animation: popupAppear 0.5s ease-out;
    }

    .celebration-popup.success {
      border-color: #007bff;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }

    .celebration-popup.warning {
      border-color: #ffc107;
      background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    }

    .celebration-popup.danger {
      border-color: #dc3545;
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    }

    .celebration-emoji {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 1s infinite;
    }

    .celebration-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .celebration-message {
      font-size: 18px;
      margin-bottom: 25px;
    }

    @keyframes popupAppear {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #007bff;
      animation: confetti-fall 3s linear infinite;
      z-index: 1999;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .gabarito-section {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .gabarito-display {
      font-family: monospace;
      font-size: 18px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 15px;
    }

    .gabarito-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
    }

    .question-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .question-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .question-item.selected {
      border-color: #28a745;
      background: #e8f5e8;
    }

    .question-number {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .question-answer {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      min-height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-answer.empty {
      color: #ccc;
      font-size: 18px;
    }

    .answer-selector {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      border: 3px solid #25b9d8;
    }

    .answer-selector h3 {
      text-align: center;
      color: #333;
      margin: 0 0 20px 0;
      font-size: 20px;
    }

    .answer-options {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .answer-option {
      width: 60px;
      height: 60px;
      border: 3px solid #e0e0e0;
      border-radius: 50%;
      background: white;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .answer-option:hover {
      border-color: #25b9d8;
      background: #e8f8fc;
      transform: scale(1.1);
    }

    .answer-option.selected {
      border-color: #28a745;
      background: #28a745;
      color: white;
    }

    .selector-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    .overlay.show {
      display: block;
    }

    .gabarito-summary {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid #28a745;
    }

    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #28a745;
      margin: 0 0 15px 0;
      text-align: center;
    }

    .summary-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px;
      font-family: monospace;
      font-size: 14px;
    }

    .summary-item {
      text-align: center;
      padding: 5px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 15px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #28a745;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e0e0e0;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin: 0;
    }

    .stat-label {
      color: #666;
      margin: 5px 0 0 0;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .loading.show {
      display: block;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 600;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid #e0e0e0;
    }

    .chart-container h3 {
      color: #333;
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }

    .chart-container canvas {
      max-width: 100%;
      height: auto;
    }

    .auto-save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .auto-save-indicator.show {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .title {
        font-size: 28px;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Indicador de salvamento autom√°tico -->
  <div id="autoSaveIndicator" class="auto-save-indicator">
   üíæ Salvo automaticamente
  </div><!-- Tela de Login -->
  <div id="loginScreen" class="container" style="max-width: 500px;">
   <div class="header">
    <h1 class="title">Sistema de Simulados</h1>
    <p class="subtitle">Acesso para Coordenadoras</p>
   </div>
   <div class="form-section">
    <h2 class="form-title">üîê Login</h2>
    <div class="form-group"><label class="form-label">Coordenadora</label> <select id="coordinatorSelect" class="form-select"> <option value="">Selecione sua coordena√ß√£o...</option> <option value="coord1">Marliane - Coordenadora 1¬∫ ano</option> <option value="coord2">Maria - Coordenadora 2¬∫ ano</option> <option value="coord3">Saldania - Coordenadora 3¬∫ ano</option> <option value="coord4">Rosa - Coordenadora 4¬∫ ano</option> <option value="coord5">Luiza - Coordenadora 5¬∫ ano</option> </select>
    </div>
    <div class="form-group"><label class="form-label">Senha</label> <input type="password" id="passwordInput" class="form-input" placeholder="Digite sua senha">
    </div><button class="btn btn-primary" onclick="login()" style="width: 100%;">üöÄ Entrar no Sistema</button>
    <div id="loginMessage" style="margin-top: 15px;"></div>
   </div>
  </div><!-- Sistema Principal -->
  <div id="mainSystem" class="container" style="display: none;">
   <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
     <div>
      <h1 class="title" id="systemTitle">Sistema de Simulados</h1>
      <p class="subtitle" id="examName">Simulado Mensal - Janeiro 2024</p>
     </div>
     <div style="text-align: right;">
      <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;" id="currentCoordinator"></div><button class="btn btn-danger btn-small" onclick="logout()">üö™ Sair</button>
     </div>
    </div>
   </div>
   <div class="tabs"><button class="tab active" onclick="showTab('gabarito')">üìù Gabarito</button> <button class="tab" onclick="showTab('schools')">üè´ Escolas</button> <button class="tab" onclick="showTab('classes')">üìö Turmas</button> <button class="tab" onclick="showTab('students')">üë• Alunos</button> <button class="tab" onclick="showTab('allocation')">üéØ Aloca√ß√£o</button> <button class="tab" onclick="showTab('answers')">‚úèÔ∏è Respostas</button> <button class="tab" onclick="showTab('lista')">üìã Lista</button> <button class="tab" onclick="showTab('results')">üìä Resultados</button> <button class="tab" onclick="showTab('charts')">üìà Gr√°ficos</button>
   </div><!-- Tab Escolas -->
   <div id="schools" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üè´ Cadastrar Nova Escola</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Nome da Escola</label> <input type="text" id="schoolName" class="form-input" placeholder="Ex: Escola Municipal Jo√£o Silva">
      </div>
      <div class="form-group"><label class="form-label">Endere√ßo</label> <input type="text" id="schoolAddress" class="form-input" placeholder="Ex: Rua das Flores, 123">
      </div>
     </div><button class="btn btn-primary" onclick="addSchool()">‚ûï Cadastrar Escola</button>
    </div>
    <div class="form-section">
     <h2 class="form-title">üìã Escolas Cadastradas</h2>
     <div class="loading" id="schoolsLoading">
      Carregando escolas...
     </div>
     <div id="schoolsList" class="students-grid"></div>
    </div>
   </div><!-- Tab Turmas -->
   <div id="classes" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üìö Cadastrar Nova Turma</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Selecionar Escola</label> <select id="classSchoolSelect" class="form-select"> <option value="">Selecione uma escola...</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Nome da Turma</label> <input type="text" id="className" class="form-input" placeholder="Ex: 3¬∫ A, 2¬∫ B, 1¬∫ Ano Manh√£">
      </div>
      <div class="form-group"><label class="form-label">Turno</label> <select id="classShift" class="form-select"> <option value="">Selecione o turno...</option> <option value="Manh√£">Manh√£</option> <option value="Tarde">Tarde</option> <option value="Noite">Noite</option> <option value="Integral">Integral</option> </select>
      </div>
     </div><button class="btn btn-primary" onclick="addClass()">‚ûï Cadastrar Turma</button>
    </div>
    <div class="form-section">
     <h2 class="form-title">üéØ Filtrar Turmas por Escola</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Escola</label> <select id="classFilterSchool" class="form-select" onchange="filterClassesBySchool()"> <option value="">üìã Todas as Escolas</option> </select>
      </div>
      <div class="form-group">
       <div style="display: flex; align-items: center; gap: 15px; margin-top: 25px;">
        <div style="color: #666; font-weight: bold;">
         Total de turmas:
        </div>
        <div id="filteredClassesCount" style="color: #25b9d8; font-weight: bold; font-size: 18px;">
         0
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="loading" id="classesLoading">
     Carregando turmas...
    </div>
    <div id="classesList" class="students-grid"></div>
   </div><!-- Tab Gabarito -->
   <div id="gabarito" class="tab-content active">
    <div class="gabarito-section">
     <h2 class="form-title">üìù Definir Gabarito Oficial</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">M√™s do Simulado</label> <select id="simuladoMonth" class="form-select" onchange="loadGabarito()"> <option value="Janeiro">Janeiro</option> <option value="Fevereiro">Fevereiro</option> <option value="Mar√ßo">Mar√ßo</option> <option value="Abril">Abril</option> <option value="Maio">Maio</option> <option value="Junho">Junho</option> <option value="Julho">Julho</option> <option value="Agosto">Agosto</option> <option value="Setembro">Setembro</option> <option value="Outubro">Outubro</option> <option value="Novembro">Novembro</option> <option value="Dezembro">Dezembro</option> </select>
      </div>
      <div class="form-group"><label class="form-label">N√∫mero de Quest√µes</label>
       <div style="display: flex; gap: 10px; align-items: center;"><input type="number" id="totalQuestions" class="form-input" value="20" min="1" max="100" style="width: 100px;"> <button class="btn btn-primary" onclick="generateGabaritoGrid()">üîÑ Gerar Grade</button>
       </div>
      </div>
     </div>
     <div id="gabaritoGrid" class="gabarito-grid"></div>
     <div id="gabaritoSummary" class="gabarito-summary" style="display: none;"></div>
    </div>
   </div><!-- Tab Alunos -->
   <div id="students" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üë• Cadastrar Novo Aluno</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Nome do Aluno</label> <input type="text" id="studentName" class="form-input" placeholder="Digite o nome completo">
      </div>
      <div class="form-group"><label class="form-label">CPF (opcional)</label> <input type="text" id="studentCPF" class="form-input" placeholder="000.000.000-00">
      </div>
      <div class="form-group"><label class="form-label">Data de Nascimento</label> <input type="date" id="studentBirthDate" class="form-input">
      </div>
     </div><button class="btn btn-primary" onclick="addStudent()">‚ûï Cadastrar Aluno</button>
    </div>
    <div class="form-section">
     <h2 class="form-title">üîç Filtrar Alunos</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Status</label> <select id="studentStatusFilter" class="form-select" onchange="filterStudents()"> <option value="">üìã Todos os Alunos</option> <option value="allocated">‚úÖ Alocados em Turmas</option> <option value="unallocated">‚ö†Ô∏è N√£o Alocados</option> </select>
      </div>
      <div class="form-group">
       <div style="display: flex; align-items: center; gap: 15px; margin-top: 25px;">
        <div style="color: #666; font-weight: bold;">
         Total de alunos:
        </div>
        <div id="filteredStudentsCount" style="color: #25b9d8; font-weight: bold; font-size: 18px;">
         0
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="loading" id="studentsLoading">
     Carregando alunos...
    </div>
    <div id="studentsList" class="students-grid"></div>
   </div><!-- Tab Aloca√ß√£o -->
   <div id="allocation" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üéØ Alocar Aluno em Turma</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Selecionar Escola</label> <select id="allocationSchoolSelect" class="form-select" onchange="updateAllocationClasses()"> <option value="">Selecione uma escola...</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Selecionar Turma</label> <select id="allocationClassSelect" class="form-select" onchange="updateAllocationStudents()"> <option value="">Selecione uma turma...</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Selecionar Aluno</label> <select id="allocationStudentSelect" class="form-select"> <option value="">Selecione um aluno...</option> </select>
      </div>
     </div><button class="btn btn-primary" onclick="allocateStudent()">üéØ Alocar Aluno</button>
    </div>
    <div class="form-section">
     <h2 class="form-title">üìã Visualizar Aloca√ß√µes</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Filtrar por Escola</label> <select id="allocationFilterSchool" class="form-select" onchange="filterAllocations()"> <option value="">üìã Todas as Escolas</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Filtrar por Turma</label> <select id="allocationFilterClass" class="form-select" onchange="filterAllocations()"> <option value="">üìö Todas as Turmas</option> </select>
      </div>
     </div>
    </div>
    <div class="loading" id="allocationsLoading">
     Carregando aloca√ß√µes...
    </div>
    <div id="allocationsList" class="students-grid"></div>
   </div><!-- Tab Respostas -->
   <div id="answers" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">‚úèÔ∏è Lan√ßar Respostas do Aluno</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Selecionar Escola</label> <select id="answersSchoolSelect" class="form-select" onchange="updateAnswersClasses()"> <option value="">Selecione uma escola...</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Selecionar Turma</label> <select id="answersClassSelect" class="form-select" onchange="updateAnswersStudents()"> <option value="">Selecione uma turma...</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Selecionar Aluno</label> <select id="studentSelect" class="form-select" onchange="loadStudentAnswers()"> <option value="">Selecione um aluno...</option> </select>
      </div>
     </div>
     <div id="studentAnswersSection" style="display: none;">
      <div style="margin: 20px 0; text-align: center;">
       <h3 style="color: #333; margin: 0 0 10px 0;">Respostas do Aluno</h3>
       <p style="color: #666; margin: 0;">Clique em cada quest√£o para selecionar a resposta</p>
      </div>
      <div id="studentAnswersGrid" class="gabarito-grid"></div>
      <div style="margin-top: 20px; text-align: center;"><button class="btn btn-success" onclick="submitAnswers()" id="submitAnswersBtn">üì§ Enviar Respostas</button> <button class="btn" onclick="clearAllStudentAnswers()" style="background: #6c757d; color: white; margin-left: 10px;">üóëÔ∏è Limpar Tudo</button>
      </div>
      <div id="studentAnswersSummary" class="gabarito-summary" style="display: none;"></div>
     </div>
    </div>
   </div><!-- Tab Lista -->
   <div id="lista" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üìã Lista de Resultados</h2>
     <div class="loading" id="listaLoading">
      Carregando lista...
     </div>
     <div id="listaContent"></div>
    </div>
   </div><!-- Tab Resultados -->
   <div id="results" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üîç Filtrar Resultados</h2>
     <div class="form-grid">
      <div class="form-group"><label class="form-label">Filtrar por Escola</label> <select id="resultsFilterSchool" class="form-select" onchange="filterResults()"> <option value="">üìã Todas as Escolas</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Filtrar por Turma</label> <select id="resultsFilterClass" class="form-select" onchange="filterResults()"> <option value="">üìö Todas as Turmas</option> </select>
      </div>
      <div class="form-group"><label class="form-label">Filtrar por Categoria</label> <select id="resultsFilterCategory" class="form-select" onchange="filterResults()"> <option value="">üéØ Todas as Categorias</option> <option value="Adequado">‚úÖ Adequado</option> <option value="Intermedi√°rio">‚ö†Ô∏è Intermedi√°rio</option> <option value="Defasagem">‚ùå Defasagem</option> </select>
      </div>
     </div>
     <div style="margin-top: 20px; text-align: center;"><button class="btn btn-success" onclick="exportResultsToFile()" style="font-size: 16px; padding: 12px 30px;"> üì• Gerar Arquivo com Resultados </button>
     </div>
    </div>
    <div class="stats-grid">
     <div class="stat-card">
      <div class="stat-number" id="totalStudents">
       0
      </div>
      <div class="stat-label">
       Total de Alunos
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="studentsWithAnswers">
       0
      </div>
      <div class="stat-label">
       Responderam
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="averageScore">
       0%
      </div>
      <div class="stat-label">
       M√©dia Geral
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="excellentCount">
       0
      </div>
      <div class="stat-label">
       Adequado
      </div>
     </div>
    </div>
    <div class="loading" id="resultsLoading">
     Carregando resultados...
    </div>
    <div id="resultsList" class="students-grid"></div>
   </div><!-- Tab Gr√°ficos -->
   <div id="charts" class="tab-content">
    <div class="form-section">
     <h2 class="form-title">üìà An√°lise de Desempenho</h2>
     <div class="chart-container">
      <h3>Distribui√ß√£o por Categoria</h3>
      <canvas id="categoryChart" width="400" height="200"></canvas>
     </div>
     <div class="chart-container">
      <h3>Desempenho por Escola</h3>
      <canvas id="schoolChart" width="400" height="200"></canvas>
     </div>
     <div class="chart-container">
      <h3>Distribui√ß√£o de Notas</h3>
      <canvas id="scoreChart" width="400" height="200"></canvas>
     </div>
    </div>
   </div>
   <div id="messages"></div>
  </div><!-- Rodap√© -->
  <footer style="background: linear-gradient(135deg, #25b9d8 0%, #1a8fa8 100%); color: white; text-align: center; padding: 20px; margin-top: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
   <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
    üè´ Secretaria Municipal de Cocal dos Alves
   </div>
   <div style="font-size: 16px; font-style: italic; margin-bottom: 15px;">
    "Ensinando com amor, transformando com dedica√ß√£o"
   </div>
   <div style="font-size: 14px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
    üíª Desenvolvido por <strong>@FranciscoSilva</strong>
   </div>
  </footer><!-- Modal para sele√ß√£o de resposta -->
  <div id="overlay" class="overlay" onclick="closeAnswerSelector()"></div>
  <div id="answerSelector" class="answer-selector" style="display: none;">
   <h3>Quest√£o <span id="currentQuestionNumber">1</span></h3>
   <div class="answer-options">
    <div class="answer-option" onclick="selectAnswer('A')">
     A
    </div>
    <div class="answer-option" onclick="selectAnswer('B')">
     B
    </div>
    <div class="answer-option" onclick="selectAnswer('C')">
     C
    </div>
    <div class="answer-option" onclick="selectAnswer('D')">
     D
    </div>
    <div class="answer-option" onclick="selectAnswer('E')">
     E
    </div>
   </div>
   <div class="selector-buttons"><button class="btn btn-success" onclick="confirmAnswer()">‚úì Confirmar</button> <button class="btn btn-danger" onclick="clearAnswer()">üóëÔ∏è Limpar</button> <button class="btn" onclick="closeAnswerSelector()" style="background: #6c757d; color: white;">‚úï Cancelar</button>
   </div>
  </div>
  <script>
    const defaultConfig = {
      system_title: "Sistema de Simulados",
      exam_name: "Simulado Mensal - Janeiro 2024",
      total_questions: "20",
      adequate_threshold: "80",
      intermediate_threshold: "50",
      primary_color: "#25b9d8",
      secondary_color: "#1a8fa8",
      background_color: "#f8f9fa",
      text_color: "#333333",
      success_color: "#28a745"
    };

    let allData = [];
    let currentGabarito = [];
    let currentCoordinatorId = null;
    let currentMonth = 'Janeiro';

    // Senhas das coordenadoras (em produ√ß√£o, isso seria mais seguro)
    const coordinatorPasswords = {
      'coord1': 'marliane123',
      'coord2': 'maria123', 
      'coord3': 'saldania123',
      'coord4': 'rosa123',
      'coord5': 'luiza123'
    };

    const coordinatorNames = {
      'coord1': 'Marliane - Coordenadora 1¬∫ ano',
      'coord2': 'Maria - Coordenadora 2¬∫ ano',
      'coord3': 'Saldania - Coordenadora 3¬∫ ano',
      'coord4': 'Rosa - Coordenadora 4¬∫ ano',
      'coord5': 'Luiza - Coordenadora 5¬∫ ano'
    };

    function loadAllData() {
      try {
        const savedData = localStorage.getItem('simuladosData');
        if (savedData) {
          allData = JSON.parse(savedData);
          console.log('Dados carregados:', allData.length, 'registros');
        } else {
          allData = [];
          console.log('Nenhum dado salvo encontrado');
        }
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        allData = [];
      }
      
      updateSchoolsList();
      updateClassesList();
      updateStudentsList();
      updateAllSelects();
      updateResults();
      loadGabarito();
    }

    // Fun√ß√µes para Escolas
    function addSchool() {
      if (!currentCoordinatorId) {
        showMessage('Erro: Fa√ßa login primeiro!', 'error');
        return;
      }

      const name = document.getElementById('schoolName').value.trim();
      const address = document.getElementById('schoolAddress').value.trim();

      if (!name) {
        showMessage('Por favor, preencha o nome da escola', 'error');
        return;
      }

      // Verificar se j√° existe escola com mesmo nome
      const existingSchool = allData.find(item => 
        item.type === 'school' && 
        item.coordinator_id === currentCoordinatorId && 
        item.name.toLowerCase() === name.toLowerCase()
      );

      if (existingSchool) {
        showMessage('J√° existe uma escola com este nome!', 'error');
        return;
      }

      const schoolData = {
        id: `school_${currentCoordinatorId}_${Date.now()}`,
        __backendId: generateId(),
        type: 'school',
        coordinator_id: currentCoordinatorId,
        name: name,
        address: address || '',
        created_at: new Date().toISOString()
      };

      try {
        allData.push(schoolData);
        const saved = saveAllData();
        
        if (saved) {
          showMessage(`‚úÖ Escola "${name}" cadastrada com sucesso!`, 'success');
          
          // Limpar campos
          document.getElementById('schoolName').value = '';
          document.getElementById('schoolAddress').value = '';
          
          // Atualizar listas
          updateSchoolsList();
          updateAllSelects();
        }
        
      } catch (error) {
        console.error('Erro ao cadastrar escola:', error);
        showMessage('Erro ao salvar escola. Tente novamente.', 'error');
      }
    }

    function updateSchoolsList() {
      if (!currentCoordinatorId) return;
      
      const schools = allData.filter(item => 
        item.type === 'school' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const container = document.getElementById('schoolsList');
      const loading = document.getElementById('schoolsLoading');

      loading.classList.remove('show');

      if (schools.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma escola cadastrada ainda.</p>';
        return;
      }

      container.innerHTML = schools.map(school => `
        <div class="student-card">
          <div class="student-name">${school.name}</div>
          <div class="student-class">üìç ${school.address || 'Endere√ßo n√£o informado'}</div>
          <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-danger btn-small" onclick="deleteSchool('${school.__backendId}')">üóëÔ∏è Remover</button>
          </div>
        </div>
      `).join('');
    }

    function deleteSchool(backendId) {
      // Verificar se h√° turmas vinculadas
      const linkedClasses = allData.filter(item => 
        item.type === 'class' && 
        item.school_id === backendId
      );

      if (linkedClasses.length > 0) {
        showMessage('N√£o √© poss√≠vel excluir esta escola pois h√° turmas vinculadas a ela!', 'error');
        return;
      }

      const schoolIndex = allData.findIndex(item => item.__backendId === backendId);
      if (schoolIndex !== -1) {
        const schoolName = allData[schoolIndex].name;
        allData.splice(schoolIndex, 1);
        saveAllData();
        showMessage(`Escola "${schoolName}" removida com sucesso!`, 'success');
        updateSchoolsList();
        updateAllSelects();
      }
    }

    // Fun√ß√µes para Turmas
    function addClass() {
      if (!currentCoordinatorId) {
        showMessage('Erro: Fa√ßa login primeiro!', 'error');
        return;
      }

      const schoolId = document.getElementById('classSchoolSelect').value;
      const name = document.getElementById('className').value.trim();
      const shift = document.getElementById('classShift').value;

      if (!schoolId || !name || !shift) {
        showMessage('Por favor, preencha todos os campos', 'error');
        return;
      }

      // Verificar se j√° existe turma com mesmo nome na mesma escola
      const existingClass = allData.find(item => 
        item.type === 'class' && 
        item.school_id === schoolId && 
        item.name.toLowerCase() === name.toLowerCase()
      );

      if (existingClass) {
        showMessage('J√° existe uma turma com este nome nesta escola!', 'error');
        return;
      }

      const classData = {
        id: `class_${currentCoordinatorId}_${Date.now()}`,
        __backendId: generateId(),
        type: 'class',
        coordinator_id: currentCoordinatorId,
        school_id: schoolId,
        name: name,
        shift: shift,
        created_at: new Date().toISOString()
      };

      try {
        allData.push(classData);
        const saved = saveAllData();
        
        if (saved) {
          showMessage(`‚úÖ Turma "${name}" cadastrada com sucesso!`, 'success');
          
          // Limpar campos
          document.getElementById('className').value = '';
          document.getElementById('classShift').value = '';
          
          // Atualizar listas
          updateClassesList();
          updateAllSelects();
        }
        
      } catch (error) {
        console.error('Erro ao cadastrar turma:', error);
        showMessage('Erro ao salvar turma. Tente novamente.', 'error');
      }
    }

    function updateClassesList() {
      if (!currentCoordinatorId) return;
      
      const classes = allData.filter(item => 
        item.type === 'class' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      // Atualizar filtro de escolas para turmas
      updateClassSchoolFilter(classes);
      
      // Aplicar filtro atual
      filterClassesBySchool();
    }

    function updateClassSchoolFilter(classes) {
      const schoolFilter = document.getElementById('classFilterSchool');
      const currentFilter = schoolFilter.value;
      
      // Obter escolas √∫nicas das turmas
      const schoolIds = [...new Set(classes.map(cls => cls.school_id))];
      const schools = allData.filter(item => 
        item.type === 'school' && 
        schoolIds.includes(item.__backendId)
      );
      
      // Atualizar op√ß√µes do select
      schoolFilter.innerHTML = '<option value="">üìã Todas as Escolas</option>' + 
        schools.map(school => `<option value="${school.__backendId}">${school.name}</option>`).join('');
      
      // Restaurar filtro anterior se ainda existir
      if (schoolIds.includes(currentFilter)) {
        schoolFilter.value = currentFilter;
      }
    }

    function filterClassesBySchool() {
      if (!currentCoordinatorId) return;
      
      const classes = allData.filter(item => 
        item.type === 'class' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const selectedSchoolId = document.getElementById('classFilterSchool').value;
      const container = document.getElementById('classesList');
      const loading = document.getElementById('classesLoading');
      const countElement = document.getElementById('filteredClassesCount');

      loading.classList.remove('show');

      // Filtrar por escola se selecionada
      let filteredClasses = classes;
      if (selectedSchoolId) {
        filteredClasses = classes.filter(cls => cls.school_id === selectedSchoolId);
      }

      // Atualizar contador
      countElement.textContent = filteredClasses.length;

      if (filteredClasses.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma turma encontrada.</p>';
        return;
      }

      // Obter dados das escolas
      const schools = allData.filter(item => item.type === 'school');
      const schoolsMap = {};
      schools.forEach(school => {
        schoolsMap[school.__backendId] = school.name;
      });

      container.innerHTML = filteredClasses.map(cls => `
        <div class="student-card">
          <div class="student-name">${cls.name}</div>
          <div class="student-class">üè´ ${schoolsMap[cls.school_id] || 'Escola n√£o encontrada'}</div>
          <div class="student-class">üïê ${cls.shift}</div>
          <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-danger btn-small" onclick="deleteClass('${cls.__backendId}')">üóëÔ∏è Remover</button>
          </div>
        </div>
      `).join('');
    }

    function deleteClass(backendId) {
      // Verificar se h√° alunos alocados nesta turma
      const linkedAllocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.class_id === backendId
      );

      if (linkedAllocations.length > 0) {
        showMessage('N√£o √© poss√≠vel excluir esta turma pois h√° alunos alocados nela!', 'error');
        return;
      }

      const classIndex = allData.findIndex(item => item.__backendId === backendId);
      if (classIndex !== -1) {
        const className = allData[classIndex].name;
        allData.splice(classIndex, 1);
        saveAllData();
        showMessage(`Turma "${className}" removida com sucesso!`, 'success');
        updateClassesList();
        updateAllSelects();
      }
    }

    function saveAllData() {
      try {
        localStorage.setItem('simuladosData', JSON.stringify(allData));
        console.log('Dados salvos:', allData.length, 'registros');
        showAutoSaveIndicator();
        return true;
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        showMessage('Erro ao salvar dados. Verifique o espa√ßo de armazenamento.', 'error');
        return false;
      }
    }

    function showAutoSaveIndicator() {
      const indicator = document.getElementById('autoSaveIndicator');
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }

    function generateId() {
      return Date.now().toString() + Math.random().toString(36).substr(2, 9);
    }

    async function initializeApp() {
      loadAllData();
    }

    function login() {
      const coordinatorId = document.getElementById('coordinatorSelect').value;
      const password = document.getElementById('passwordInput').value;
      const messageDiv = document.getElementById('loginMessage');

      if (!coordinatorId) {
        messageDiv.innerHTML = '<div class="message error">Por favor, selecione uma coordena√ß√£o</div>';
        return;
      }

      if (!password) {
        messageDiv.innerHTML = '<div class="message error">Por favor, digite a senha</div>';
        return;
      }

      if (coordinatorPasswords[coordinatorId] === password) {
        currentCoordinatorId = coordinatorId;
        document.getElementById('currentCoordinator').textContent = coordinatorNames[coordinatorId];
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').style.display = 'block';
        messageDiv.innerHTML = '';
        
        // Limpar campos de login
        document.getElementById('coordinatorSelect').value = '';
        document.getElementById('passwordInput').value = '';
        
        console.log('Login realizado:', coordinatorId);
        
        // Atualizar dados filtrados
        updateStudentsList();
        updateResults();
      } else {
        messageDiv.innerHTML = '<div class="message error">Senha incorreta! Tente novamente.</div>';
      }
    }

    function logout() {
      currentCoordinatorId = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainSystem').style.display = 'none';
      
      // Limpar apenas a visualiza√ß√£o, mas manter os dados salvos no localStorage
      document.getElementById('studentsList').innerHTML = '';
      document.getElementById('resultsList').innerHTML = '';
      document.getElementById('schoolsList').innerHTML = '';
      document.getElementById('classesList').innerHTML = '';
      document.getElementById('allocationsList').innerHTML = '';
      
      console.log('Logout realizado - Dados mantidos no localStorage');
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      if (tabName === 'charts') {
        setTimeout(updateCharts, 100);
      } else if (tabName === 'lista') {
        updateLista();
      } else if (tabName === 'results') {
        updateResultsFilters();
        filterResults();
      }
    }

    let gabaritoAnswers = {};
    let studentAnswers = {};
    let currentEditingQuestion = null;
    let selectedAnswer = null;
    let isEditingStudent = false;
    let currentStudentId = null;

    function generateGabaritoGrid() {
      const totalQuestions = parseInt(document.getElementById('totalQuestions').value);
      if (!totalQuestions || totalQuestions < 1 || totalQuestions > 100) {
        showMessage('Por favor, insira um n√∫mero v√°lido de quest√µes (1-100)', 'error');
        return;
      }

      const grid = document.getElementById('gabaritoGrid');
      
      grid.innerHTML = '';
      gabaritoAnswers = {};
      
      for (let i = 1; i <= totalQuestions; i++) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item';
        questionDiv.onclick = () => openAnswerSelector(i);
        
        questionDiv.innerHTML = `
          <div class="question-number">Q${i}</div>
          <div class="question-answer empty" id="answer-${i}">?</div>
        `;
        
        grid.appendChild(questionDiv);
      }
      
      updateGabaritoProgress();
    }

    function openAnswerSelector(questionNumber, isStudent = false) {
      currentEditingQuestion = questionNumber;
      isEditingStudent = isStudent;
      
      if (isStudent) {
        selectedAnswer = studentAnswers[questionNumber] || null;
      } else {
        selectedAnswer = gabaritoAnswers[questionNumber] || null;
      }
      
      document.getElementById('currentQuestionNumber').textContent = questionNumber;
      
      // Limpar sele√ß√µes anteriores
      document.querySelectorAll('.answer-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Marcar resposta atual se existir
      if (selectedAnswer) {
        const currentOption = document.querySelector(`.answer-option:nth-child(${['A','B','C','D','E'].indexOf(selectedAnswer) + 1})`);
        if (currentOption) {
          currentOption.classList.add('selected');
        }
      }
      
      document.getElementById('overlay').classList.add('show');
      document.getElementById('answerSelector').style.display = 'block';
    }

    function selectAnswer(answer) {
      selectedAnswer = answer;
      
      // Limpar sele√ß√µes anteriores
      document.querySelectorAll('.answer-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Marcar nova sele√ß√£o
      event.target.classList.add('selected');
    }

    function confirmAnswer() {
      if (selectedAnswer && currentEditingQuestion) {
        if (isEditingStudent) {
          studentAnswers[currentEditingQuestion] = selectedAnswer;
          
          const answerElement = document.getElementById(`student-answer-${currentEditingQuestion}`);
          answerElement.textContent = selectedAnswer;
          answerElement.classList.remove('empty');
          
          const questionItem = answerElement.parentElement;
          questionItem.classList.add('selected');
          
          updateStudentAnswersProgress();
        } else {
          gabaritoAnswers[currentEditingQuestion] = selectedAnswer;
          
          const answerElement = document.getElementById(`answer-${currentEditingQuestion}`);
          answerElement.textContent = selectedAnswer;
          answerElement.classList.remove('empty');
          
          const questionItem = answerElement.parentElement;
          questionItem.classList.add('selected');
          
          updateGabaritoProgress();
          
          // Salvamento autom√°tico do gabarito
          autoSaveGabarito();
        }
        
        closeAnswerSelector();
      }
    }

    function clearAnswer() {
      if (currentEditingQuestion) {
        if (isEditingStudent) {
          delete studentAnswers[currentEditingQuestion];
          
          const answerElement = document.getElementById(`student-answer-${currentEditingQuestion}`);
          answerElement.textContent = '?';
          answerElement.classList.add('empty');
          
          const questionItem = answerElement.parentElement;
          questionItem.classList.remove('selected');
          
          updateStudentAnswersProgress();
        } else {
          delete gabaritoAnswers[currentEditingQuestion];
          
          const answerElement = document.getElementById(`answer-${currentEditingQuestion}`);
          answerElement.textContent = '?';
          answerElement.classList.add('empty');
          
          const questionItem = answerElement.parentElement;
          questionItem.classList.remove('selected');
          
          updateGabaritoProgress();
          
          // Salvamento autom√°tico do gabarito
          autoSaveGabarito();
        }
        
        closeAnswerSelector();
      }
    }

    function closeAnswerSelector() {
      document.getElementById('overlay').classList.remove('show');
      document.getElementById('answerSelector').style.display = 'none';
      currentEditingQuestion = null;
      selectedAnswer = null;
      isEditingStudent = false;
    }

    function updateGabaritoProgress() {
      const totalQuestions = parseInt(document.getElementById('totalQuestions').value);
      const answeredQuestions = Object.keys(gabaritoAnswers).length;
      const percentage = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
      
      const summary = document.getElementById('gabaritoSummary');
      
      if (answeredQuestions > 0) {
        summary.style.display = 'block';
        
        const summaryContent = [];
        for (let i = 1; i <= totalQuestions; i++) {
          summaryContent.push(`<div class="summary-item">${i}: ${gabaritoAnswers[i] || '?'}</div>`);
        }
        
        summary.innerHTML = `
          <div class="summary-title">Progresso do Gabarito</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%"></div>
          </div>
          <div style="text-align: center; margin-bottom: 15px; font-weight: bold;">
            ${answeredQuestions} de ${totalQuestions} quest√µes preenchidas (${Math.round(percentage)}%)
          </div>
          <div class="summary-content">${summaryContent.join('')}</div>
        `;
      } else {
        summary.style.display = 'none';
      }
    }

    function autoSaveGabarito() {
      if (!currentCoordinatorId) return;
      
      const totalQuestions = parseInt(document.getElementById('totalQuestions').value);
      const selectedMonth = document.getElementById('simuladoMonth').value;
      const answeredQuestions = Object.keys(gabaritoAnswers).length;
      
      if (answeredQuestions === 0) return;

      // Converter para array ordenado
      const gabaritoArray = [];
      for (let i = 1; i <= totalQuestions; i++) {
        gabaritoArray.push(gabaritoAnswers[i] || '');
      }

      const gabaritoData = {
        id: `gabarito_${currentCoordinatorId}_${selectedMonth}`,
        __backendId: generateId(),
        type: 'gabarito',
        coordinator_id: currentCoordinatorId,
        month: selectedMonth,
        answers: JSON.stringify(gabaritoArray),
        total_questions: totalQuestions,
        created_at: new Date().toISOString()
      };

      const existingIndex = allData.findIndex(item => 
        item.type === 'gabarito' && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === selectedMonth
      );
      
      if (existingIndex !== -1) {
        allData[existingIndex] = { ...allData[existingIndex], ...gabaritoData };
      } else {
        allData.push(gabaritoData);
      }
      
      saveAllData();
      currentMonth = selectedMonth;
    }

    function loadGabarito() {
      if (!currentCoordinatorId) return;
      
      const selectedMonth = document.getElementById('simuladoMonth').value;
      const gabarito = allData.find(item => 
        item.type === 'gabarito' && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === selectedMonth
      );
      
      if (gabarito) {
        currentGabarito = JSON.parse(gabarito.answers);
        currentMonth = selectedMonth;
        
        // Carregar na interface interativa
        if (gabarito.total_questions) {
          document.getElementById('totalQuestions').value = gabarito.total_questions;
          generateGabaritoGrid();
          
          // Preencher respostas salvas
          currentGabarito.forEach((answer, index) => {
            if (answer && answer.trim()) {
              const questionNumber = index + 1;
              gabaritoAnswers[questionNumber] = answer;
              
              const answerElement = document.getElementById(`answer-${questionNumber}`);
              if (answerElement) {
                answerElement.textContent = answer;
                answerElement.classList.remove('empty');
                answerElement.parentElement.classList.add('selected');
              }
            }
          });
          
          updateGabaritoProgress();
        }
      } else {
        // Limpar se n√£o houver gabarito para este m√™s
        currentGabarito = [];
        gabaritoAnswers = {};
        const grid = document.getElementById('gabaritoGrid');
        if (grid) grid.innerHTML = '';
        const summary = document.getElementById('gabaritoSummary');
        if (summary) summary.style.display = 'none';
      }
    }

    function loadStudentAnswers() {
      const studentId = document.getElementById('studentSelect').value;
      const section = document.getElementById('studentAnswersSection');
      
      if (!studentId) {
        section.style.display = 'none';
        return;
      }
      
      // Verificar se existe gabarito ou usar n√∫mero padr√£o de quest√µes
      let totalQuestions = 20; // Padr√£o
      
      if (currentGabarito.length > 0) {
        totalQuestions = currentGabarito.length;
      } else {
        // Buscar gabarito salvo para este m√™s
        const savedGabarito = allData.find(item => 
          item.type === 'gabarito' && 
          item.coordinator_id === currentCoordinatorId && 
          item.month === currentMonth
        );
        
        if (savedGabarito) {
          totalQuestions = savedGabarito.total_questions || 20;
          currentGabarito = JSON.parse(savedGabarito.answers);
        } else {
          // Usar n√∫mero de quest√µes definido na aba gabarito
          const definedQuestions = parseInt(document.getElementById('totalQuestions').value);
          if (definedQuestions && definedQuestions > 0) {
            totalQuestions = definedQuestions;
          }
          // Criar gabarito vazio tempor√°rio
          currentGabarito = new Array(totalQuestions).fill('');
        }
      }
      
      currentStudentId = studentId;
      section.style.display = 'block';
      
      // Limpar respostas anteriores
      studentAnswers = {};
      
      // Verificar se j√° existem respostas salvas para este aluno neste m√™s
      const existingAnswers = allData.find(item => 
        item.type === 'answers' && 
        item.student_id === studentId && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      
      if (existingAnswers) {
        const savedAnswers = JSON.parse(existingAnswers.answers);
        savedAnswers.forEach((answer, index) => {
          if (answer && answer.trim()) {
            studentAnswers[index + 1] = answer;
          }
        });
        
        // Mostrar informa√ß√£o de que j√° existe resultado
        const studentData = allData.find(s => s.type === 'student' && s.id === studentId);
        showMessage(`üìù Editando respostas de ${studentData?.name || 'aluno'} - Resultado atual: ${existingAnswers.score}/${currentGabarito.length} (${existingAnswers.percentage}%) - ${existingAnswers.category}`, 'success');
        
        // Atualizar texto do bot√£o
        document.getElementById('submitAnswersBtn').innerHTML = 'üíæ Atualizar Respostas';
      } else {
        // Novo lan√ßamento
        document.getElementById('submitAnswersBtn').innerHTML = 'üì§ Enviar Respostas';
      }
      
      generateStudentAnswersGrid();
    }

    function generateStudentAnswersGrid() {
      const grid = document.getElementById('studentAnswersGrid');
      const totalQuestions = currentGabarito.length;
      
      grid.innerHTML = '';
      
      for (let i = 1; i <= totalQuestions; i++) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item';
        questionDiv.onclick = () => openAnswerSelector(i, true);
        
        const answer = studentAnswers[i] || '';
        const isEmpty = !answer;
        
        questionDiv.innerHTML = `
          <div class="question-number">Q${i}</div>
          <div class="question-answer ${isEmpty ? 'empty' : ''}" id="student-answer-${i}">${isEmpty ? '?' : answer}</div>
        `;
        
        if (!isEmpty) {
          questionDiv.classList.add('selected');
        }
        
        grid.appendChild(questionDiv);
      }
      
      updateStudentAnswersProgress();
    }

    function updateStudentAnswersProgress() {
      const totalQuestions = currentGabarito.length;
      const answeredQuestions = Object.keys(studentAnswers).length;
      const percentage = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
      
      const summary = document.getElementById('studentAnswersSummary');
      
      if (answeredQuestions > 0) {
        summary.style.display = 'block';
        
        const summaryContent = [];
        for (let i = 1; i <= totalQuestions; i++) {
          summaryContent.push(`<div class="summary-item">${i}: ${studentAnswers[i] || '?'}</div>`);
        }
        
        summary.innerHTML = `
          <div class="summary-title">Progresso das Respostas</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%"></div>
          </div>
          <div style="text-align: center; margin-bottom: 15px; font-weight: bold;">
            ${answeredQuestions} de ${totalQuestions} quest√µes respondidas (${Math.round(percentage)}%)
          </div>
          <div class="summary-content">${summaryContent.join('')}</div>
        `;
      } else {
        summary.style.display = 'none';
      }
    }

    function clearAllStudentAnswers() {
      studentAnswers = {};
      generateStudentAnswersGrid();
    }

    // Fun√ß√µes para Alunos
    function addStudent() {
      if (!currentCoordinatorId) {
        showMessage('Erro: Fa√ßa login primeiro!', 'error');
        return;
      }

      const name = document.getElementById('studentName').value.trim();
      const cpf = document.getElementById('studentCPF').value.trim();
      const birthDate = document.getElementById('studentBirthDate').value;

      if (!name) {
        showMessage('Por favor, preencha o nome do aluno', 'error');
        return;
      }

      // Verificar se j√° existe aluno com mesmo nome na mesma coordena√ß√£o
      const existingStudent = allData.find(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId && 
        item.name.toLowerCase() === name.toLowerCase()
      );

      if (existingStudent) {
        showMessage('J√° existe um aluno com este nome cadastrado!', 'error');
        return;
      }

      const studentData = {
        id: `student_${currentCoordinatorId}_${Date.now()}`,
        __backendId: generateId(),
        type: 'student',
        coordinator_id: currentCoordinatorId,
        name: name,
        cpf: cpf || '',
        birth_date: birthDate || '',
        created_at: new Date().toISOString()
      };

      try {
        allData.push(studentData);
        const saved = saveAllData();
        
        if (saved) {
          showMessage(`‚úÖ Aluno "${name}" cadastrado com sucesso!`, 'success');
          
          // Limpar campos
          document.getElementById('studentName').value = '';
          document.getElementById('studentCPF').value = '';
          document.getElementById('studentBirthDate').value = '';
          
          // Atualizar listas
          updateStudentsList();
          updateAllSelects();
        }
        
      } catch (error) {
        console.error('Erro ao cadastrar aluno:', error);
        showMessage('Erro ao salvar aluno. Tente novamente.', 'error');
      }
    }

    function updateStudentsList() {
      if (!currentCoordinatorId) return;
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      // Aplicar filtro atual
      filterStudents();
    }

    function filterStudents() {
      if (!currentCoordinatorId) return;
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const statusFilter = document.getElementById('studentStatusFilter').value;
      const container = document.getElementById('studentsList');
      const loading = document.getElementById('studentsLoading');
      const countElement = document.getElementById('filteredStudentsCount');

      loading.classList.remove('show');

      // Obter aloca√ß√µes
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.coordinator_id === currentCoordinatorId
      );

      // Filtrar por status
      let filteredStudents = students;
      if (statusFilter === 'allocated') {
        const allocatedStudentIds = allocations.map(a => a.student_id);
        filteredStudents = students.filter(student => allocatedStudentIds.includes(student.__backendId));
      } else if (statusFilter === 'unallocated') {
        const allocatedStudentIds = allocations.map(a => a.student_id);
        filteredStudents = students.filter(student => !allocatedStudentIds.includes(student.__backendId));
      }

      // Atualizar contador
      countElement.textContent = filteredStudents.length;

      if (filteredStudents.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum aluno encontrado.</p>';
        return;
      }

      // Obter informa√ß√µes de aloca√ß√£o para cada aluno
      const studentsWithAllocation = filteredStudents.map(student => {
        const allocation = allocations.find(a => a.student_id === student.__backendId);
        let allocationInfo = '';
        
        if (allocation) {
          const school = allData.find(s => s.__backendId === allocation.school_id);
          const cls = allData.find(c => c.__backendId === allocation.class_id);
          allocationInfo = `üè´ ${school?.name || 'Escola n√£o encontrada'} - üìö ${cls?.name || 'Turma n√£o encontrada'}`;
        } else {
          allocationInfo = '‚ö†Ô∏è N√£o alocado em turma';
        }
        
        return { ...student, allocationInfo, isAllocated: !!allocation };
      });

      container.innerHTML = studentsWithAllocation.map(student => `
        <div class="student-card">
          <div class="student-name">${student.name}</div>
          <div class="student-class">${student.allocationInfo}</div>
          ${student.cpf ? `<div class="student-class">üìÑ CPF: ${student.cpf}</div>` : ''}
          ${student.birth_date ? `<div class="student-class">üìÖ Nascimento: ${new Date(student.birth_date).toLocaleDateString('pt-BR')}</div>` : ''}
          <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
            ${!student.isAllocated ? `<button class="btn btn-primary btn-small" onclick="quickAllocateStudent('${student.__backendId}')">üéØ Alocar</button>` : ''}
            <button class="btn btn-danger btn-small" onclick="deleteStudent('${student.__backendId}')">üóëÔ∏è Remover</button>
          </div>
        </div>
      `).join('');
    }

    function quickAllocateStudent(studentId) {
      // Ir para a aba de aloca√ß√£o
      showTab('allocation');
      document.querySelector('.tab[onclick="showTab(\'allocation\')"]').classList.add('active');
      
      // Pr√©-selecionar o aluno
      setTimeout(() => {
        document.getElementById('allocationStudentSelect').value = studentId;
        const studentData = allData.find(s => s.__backendId === studentId);
        showMessage(`üéØ Aluno "${studentData?.name}" selecionado. Escolha a escola e turma para alocar.`, 'success');
      }, 100);
    }

    // Fun√ß√µes de Aloca√ß√£o
    function allocateStudent() {
      if (!currentCoordinatorId) {
        showMessage('Erro: Fa√ßa login primeiro!', 'error');
        return;
      }

      const schoolId = document.getElementById('allocationSchoolSelect').value;
      const classId = document.getElementById('allocationClassSelect').value;
      const studentId = document.getElementById('allocationStudentSelect').value;

      if (!schoolId || !classId || !studentId) {
        showMessage('Por favor, selecione escola, turma e aluno', 'error');
        return;
      }

      // Verificar se o aluno j√° est√° alocado
      const existingAllocation = allData.find(item => 
        item.type === 'allocation' && 
        item.student_id === studentId
      );

      if (existingAllocation) {
        showMessage('Este aluno j√° est√° alocado em uma turma!', 'error');
        return;
      }

      const allocationData = {
        id: `allocation_${currentCoordinatorId}_${Date.now()}`,
        __backendId: generateId(),
        type: 'allocation',
        coordinator_id: currentCoordinatorId,
        school_id: schoolId,
        class_id: classId,
        student_id: studentId,
        created_at: new Date().toISOString()
      };

      try {
        allData.push(allocationData);
        const saved = saveAllData();
        
        if (saved) {
          const studentData = allData.find(s => s.__backendId === studentId);
          const schoolData = allData.find(s => s.__backendId === schoolId);
          const classData = allData.find(c => c.__backendId === classId);
          
          showMessage(`‚úÖ Aluno "${studentData?.name}" alocado na turma "${classData?.name}" da escola "${schoolData?.name}"!`, 'success');
          
          // Limpar sele√ß√µes
          document.getElementById('allocationSchoolSelect').value = '';
          document.getElementById('allocationClassSelect').value = '';
          document.getElementById('allocationStudentSelect').value = '';
          
          // Atualizar listas
          updateAllSelects();
          filterAllocations();
          updateStudentsList();
        }
        
      } catch (error) {
        console.error('Erro ao alocar aluno:', error);
        showMessage('Erro ao salvar aloca√ß√£o. Tente novamente.', 'error');
      }
    }

    function updateAllocationClasses() {
      const schoolId = document.getElementById('allocationSchoolSelect').value;
      const classSelect = document.getElementById('allocationClassSelect');
      
      if (!schoolId) {
        classSelect.innerHTML = '<option value="">Selecione uma turma...</option>';
        return;
      }
      
      const classes = allData.filter(item => 
        item.type === 'class' && 
        item.school_id === schoolId
      );
      
      classSelect.innerHTML = '<option value="">Selecione uma turma...</option>' + 
        classes.map(cls => `<option value="${cls.__backendId}">${cls.name} - ${cls.shift}</option>`).join('');
    }

    function updateAllocationStudents() {
      const studentSelect = document.getElementById('allocationStudentSelect');
      
      // Obter alunos n√£o alocados
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const allocatedStudentIds = allocations.map(a => a.student_id);
      const unallocatedStudents = students.filter(student => !allocatedStudentIds.includes(student.__backendId));
      
      studentSelect.innerHTML = '<option value="">Selecione um aluno...</option>' + 
        unallocatedStudents.map(student => `<option value="${student.__backendId}">${student.name}</option>`).join('');
    }

    function filterAllocations() {
      if (!currentCoordinatorId) return;
      
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const schoolFilter = document.getElementById('allocationFilterSchool').value;
      const classFilter = document.getElementById('allocationFilterClass').value;
      const container = document.getElementById('allocationsList');
      const loading = document.getElementById('allocationsLoading');

      loading.classList.remove('show');

      // Filtrar aloca√ß√µes
      let filteredAllocations = allocations;
      if (schoolFilter) {
        filteredAllocations = filteredAllocations.filter(a => a.school_id === schoolFilter);
      }
      if (classFilter) {
        filteredAllocations = filteredAllocations.filter(a => a.class_id === classFilter);
      }

      if (filteredAllocations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma aloca√ß√£o encontrada.</p>';
        return;
      }

      // Obter dados relacionados
      const students = allData.filter(item => item.type === 'student');
      const schools = allData.filter(item => item.type === 'school');
      const classes = allData.filter(item => item.type === 'class');

      const studentsMap = {};
      const schoolsMap = {};
      const classesMap = {};

      students.forEach(s => studentsMap[s.__backendId] = s);
      schools.forEach(s => schoolsMap[s.__backendId] = s);
      classes.forEach(c => classesMap[c.__backendId] = c);

      // Agrupar por escola e turma
      const groupedAllocations = {};
      filteredAllocations.forEach(allocation => {
        const schoolName = schoolsMap[allocation.school_id]?.name || 'Escola n√£o encontrada';
        const className = classesMap[allocation.class_id]?.name || 'Turma n√£o encontrada';
        const key = `${schoolName} - ${className}`;
        
        if (!groupedAllocations[key]) {
          groupedAllocations[key] = [];
        }
        groupedAllocations[key].push(allocation);
      });

      let html = '';
      Object.keys(groupedAllocations).sort().forEach(groupKey => {
        html += `
          <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #25b9d8 0%, #1a8fa8 100%); color: white; padding: 15px; border-radius: 12px; margin: 20px 0 10px 0; text-align: center; font-weight: bold; font-size: 18px;">
            üìö ${groupKey} (${groupedAllocations[groupKey].length} alunos)
          </div>
        `;
        
        groupedAllocations[groupKey].forEach(allocation => {
          const student = studentsMap[allocation.student_id];
          html += `
            <div class="student-card">
              <div class="student-name">${student?.name || 'Aluno n√£o encontrado'}</div>
              ${student?.cpf ? `<div class="student-class">üìÑ CPF: ${student.cpf}</div>` : ''}
              ${student?.birth_date ? `<div class="student-class">üìÖ Nascimento: ${new Date(student.birth_date).toLocaleDateString('pt-BR')}</div>` : ''}
              <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-danger btn-small" onclick="removeAllocation('${allocation.__backendId}')">üóëÔ∏è Remover Aloca√ß√£o</button>
              </div>
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    function removeAllocation(backendId) {
      const allocationIndex = allData.findIndex(item => item.__backendId === backendId);
      if (allocationIndex !== -1) {
        const allocation = allData[allocationIndex];
        const student = allData.find(s => s.__backendId === allocation.student_id);
        
        allData.splice(allocationIndex, 1);
        saveAllData();
        showMessage(`Aloca√ß√£o do aluno "${student?.name}" removida com sucesso!`, 'success');
        
        filterAllocations();
        updateStudentsList();
        updateAllSelects();
      }
    }

    // Fun√ß√£o unificada para atualizar todos os selects
    function updateAllSelects() {
      if (!currentCoordinatorId) return;
      
      const schools = allData.filter(item => 
        item.type === 'school' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      // Atualizar selects de escola
      const schoolSelects = [
        'classSchoolSelect',
        'allocationSchoolSelect', 
        'allocationFilterSchool',
        'answersSchoolSelect',
        'resultsFilterSchool'
      ];
      
      schoolSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          const currentValue = select.value;
          select.innerHTML = '<option value="">Selecione uma escola...</option>' + 
            schools.map(school => `<option value="${school.__backendId}">${school.name}</option>`).join('');
          
          // Restaurar valor se ainda existir
          if (schools.find(s => s.__backendId === currentValue)) {
            select.value = currentValue;
          }
        }
      });
      
      // Atualizar filtros de aloca√ß√£o
      updateAllocationFilters();
      
      // Atualizar sele√ß√£o de alunos para aloca√ß√£o
      updateAllocationStudents();
    }

    function updateAllocationFilters() {
      const schools = allData.filter(item => 
        item.type === 'school' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const classes = allData.filter(item => 
        item.type === 'class' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      // Filtro de escola para aloca√ß√µes
      const schoolFilter = document.getElementById('allocationFilterSchool');
      if (schoolFilter) {
        const currentValue = schoolFilter.value;
        schoolFilter.innerHTML = '<option value="">üìã Todas as Escolas</option>' + 
          schools.map(school => `<option value="${school.__backendId}">${school.name}</option>`).join('');
        
        if (schools.find(s => s.__backendId === currentValue)) {
          schoolFilter.value = currentValue;
        }
      }
      
      // Filtro de turma para aloca√ß√µes
      const classFilter = document.getElementById('allocationFilterClass');
      if (classFilter) {
        const currentValue = classFilter.value;
        classFilter.innerHTML = '<option value="">üìö Todas as Turmas</option>' + 
          classes.map(cls => {
            const school = schools.find(s => s.__backendId === cls.school_id);
            return `<option value="${cls.__backendId}">${cls.name} - ${school?.name || 'Escola n√£o encontrada'}</option>`;
          }).join('');
        
        if (classes.find(c => c.__backendId === currentValue)) {
          classFilter.value = currentValue;
        }
      }
    }

    // Fun√ß√µes para aba de respostas
    function updateAnswersClasses() {
      const schoolId = document.getElementById('answersSchoolSelect').value;
      const classSelect = document.getElementById('answersClassSelect');
      
      if (!schoolId) {
        classSelect.innerHTML = '<option value="">Selecione uma turma...</option>';
        document.getElementById('studentSelect').innerHTML = '<option value="">Selecione um aluno...</option>';
        return;
      }
      
      const classes = allData.filter(item => 
        item.type === 'class' && 
        item.school_id === schoolId
      );
      
      classSelect.innerHTML = '<option value="">Selecione uma turma...</option>' + 
        classes.map(cls => `<option value="${cls.__backendId}">${cls.name} - ${cls.shift}</option>`).join('');
      
      // Limpar sele√ß√£o de aluno
      document.getElementById('studentSelect').innerHTML = '<option value="">Selecione um aluno...</option>';
    }

    function updateAnswersStudents() {
      const classId = document.getElementById('answersClassSelect').value;
      const studentSelect = document.getElementById('studentSelect');
      
      if (!classId) {
        studentSelect.innerHTML = '<option value="">Selecione um aluno...</option>';
        return;
      }
      
      // Obter alunos alocados nesta turma
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.class_id === classId
      );
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const allocatedStudents = students.filter(student => 
        allocations.find(a => a.student_id === student.__backendId)
      );
      
      studentSelect.innerHTML = '<option value="">Selecione um aluno...</option>' + 
        allocatedStudents.map(student => `<option value="${student.id}">${student.name}</option>`).join('');
    }

    function deleteStudent(backendId) {
      const studentIndex = allData.findIndex(item => item.__backendId === backendId);
      if (studentIndex !== -1) {
        const studentName = allData[studentIndex].name;
        allData.splice(studentIndex, 1);
        saveAllData();
        showMessage(`Aluno "${studentName}" removido com sucesso!`, 'success');
        updateStudentsList();
        updateResults();
      }
    }

    function submitAnswers() {
      const studentId = document.getElementById('studentSelect').value;

      if (!studentId) {
        showMessage('Por favor, selecione um aluno', 'error');
        return;
      }

      // Garantir que temos um gabarito (mesmo que vazio)
      if (currentGabarito.length === 0) {
        const totalQuestions = parseInt(document.getElementById('totalQuestions').value) || 20;
        currentGabarito = new Array(totalQuestions).fill('');
      }

      const answeredQuestions = Object.keys(studentAnswers).length;
      if (answeredQuestions === 0) {
        showMessage('Por favor, preencha pelo menos uma resposta', 'error');
        return;
      }

      // Converter para array ordenado
      const answersArray = [];
      for (let i = 1; i <= currentGabarito.length; i++) {
        answersArray.push(studentAnswers[i] || '');
      }

      // Calcular pontua√ß√£o apenas para quest√µes respondidas
      let correctAnswers = 0;
      let totalAnswered = 0;
      
      for (let i = 0; i < answersArray.length; i++) {
        if (answersArray[i] && answersArray[i].trim()) {
          totalAnswered++;
          if (answersArray[i] === currentGabarito[i]) {
            correctAnswers++;
          }
        }
      }

      const percentage = totalAnswered > 0 ? Math.round((correctAnswers / currentGabarito.length) * 100) : 0;
      const category = getCategory(percentage);

      const answerData = {
        id: `answers_${studentId}_${currentMonth}`,
        __backendId: generateId(),
        type: 'answers',
        coordinator_id: currentCoordinatorId,
        month: currentMonth,
        student_id: studentId,
        answers: JSON.stringify(answersArray),
        score: correctAnswers,
        percentage: percentage,
        category: category,
        created_at: new Date().toISOString()
      };

      // Verificar se j√° existe resposta para este aluno neste m√™s
      const existingIndex = allData.findIndex(item => 
        item.type === 'answers' && 
        item.student_id === studentId && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      
      if (existingIndex !== -1) {
        allData[existingIndex] = { ...allData[existingIndex], ...answerData };
        showMessage(`Respostas atualizadas! Pontua√ß√£o: ${correctAnswers}/${currentGabarito.length} (${percentage}%) - ${category}`, 'success');
      } else {
        allData.push(answerData);
        showMessage(`Respostas enviadas! Pontua√ß√£o: ${correctAnswers}/${currentGabarito.length} (${percentage}%) - ${category}`, 'success');
      }
      
      saveAllData();
      showCelebrationPopup(category, percentage);
      
      // Limpar interface
      studentAnswers = {};
      document.getElementById('studentSelect').value = '';
      document.getElementById('studentAnswersSection').style.display = 'none';
      
      updateResults();
    }

    function getCategory(percentage) {
      const adequate = parseInt(defaultConfig.adequate_threshold);
      const intermediate = parseInt(defaultConfig.intermediate_threshold);

      if (percentage >= adequate) return 'Adequado';
      if (percentage >= intermediate) return 'Intermedi√°rio';
      return 'Defasagem';
    }

    function getCategoryClass(category) {
      switch (category) {
        case 'Adequado': return 'category-adequate';
        case 'Intermedi√°rio': return 'category-intermediate';
        case 'Defasagem': return 'category-defasagem';
        default: return 'category-defasagem';
      }
    }

    function getCategoryListClass(category) {
      switch (category) {
        case 'Adequado': return 'adequate';
        case 'Intermedi√°rio': return 'intermediate';
        case 'Defasagem': return 'defasagem';
        default: return 'defasagem';
      }
    }

    function updateLista() {
      if (!currentCoordinatorId) return;
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      const answers = allData.filter(item => 
        item.type === 'answers' && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      const loading = document.getElementById('listaLoading');
      const container = document.getElementById('listaContent');

      loading.classList.remove('show');

      // Mostrar lista dos alunos com resultados
      const studentsWithResults = students.map(student => {
        const studentAnswer = answers.find(a => a.student_id === student.id);
        return {
          ...student,
          answer: studentAnswer
        };
      }).filter(student => student.answer); // S√≥ mostrar quem j√° respondeu

      if (studentsWithResults.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum aluno respondeu ainda.</p>';
        return;
      }

      // Ordenar por categoria (Adequado primeiro, depois Intermedi√°rio, depois Defasagem)
      studentsWithResults.sort((a, b) => {
        const categoryOrder = { 'Adequado': 0, 'Intermedi√°rio': 1, 'Defasagem': 2 };
        return categoryOrder[a.answer.category] - categoryOrder[b.answer.category];
      });

      container.innerHTML = studentsWithResults.map(student => `
        <div class="list-item ${getCategoryListClass(student.answer.category)}">
          <div class="student-info">
            <div class="student-name">${student.name}</div>
            <div style="color: #666; font-size: 14px;">${student.school} - ${student.class}</div>
          </div>
          <div class="student-results">
            <div style="font-size: 18px;">${student.answer.score}/${currentGabarito.length} quest√µes</div>
            <div style="font-size: 16px;">${student.answer.percentage}%</div>
            <div style="font-size: 14px; margin-top: 5px;">${student.answer.category}</div>
            <div style="margin-top: 10px; display: flex; gap: 8px;">
              <button class="btn btn-primary btn-small" onclick="editStudentResult('${student.id}')" style="font-size: 12px; padding: 6px 12px;">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger btn-small" onclick="deleteStudentResult('${student.id}')" style="font-size: 12px; padding: 6px 12px;">üóëÔ∏è Excluir</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Atualizar filtros de resultados
    function updateResultsFilters() {
      if (!currentCoordinatorId) return;
      
      const schools = allData.filter(item => 
        item.type === 'school' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const classes = allData.filter(item => 
        item.type === 'class' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      // Filtro de escola
      const schoolFilter = document.getElementById('resultsFilterSchool');
      if (schoolFilter) {
        const currentValue = schoolFilter.value;
        schoolFilter.innerHTML = '<option value="">üìã Todas as Escolas</option>' + 
          schools.map(school => `<option value="${school.__backendId}">${school.name}</option>`).join('');
        
        if (schools.find(s => s.__backendId === currentValue)) {
          schoolFilter.value = currentValue;
        }
      }
      
      // Filtro de turma
      const classFilter = document.getElementById('resultsFilterClass');
      if (classFilter) {
        const currentValue = classFilter.value;
        classFilter.innerHTML = '<option value="">üìö Todas as Turmas</option>' + 
          classes.map(cls => {
            const school = schools.find(s => s.__backendId === cls.school_id);
            return `<option value="${cls.__backendId}">${cls.name} - ${school?.name || 'Escola n√£o encontrada'}</option>`;
          }).join('');
        
        if (classes.find(c => c.__backendId === currentValue)) {
          classFilter.value = currentValue;
        }
      }
    }

    // Filtrar resultados
    function filterResults() {
      if (!currentCoordinatorId) return;
      
      const schoolFilter = document.getElementById('resultsFilterSchool').value;
      const classFilter = document.getElementById('resultsFilterClass').value;
      const categoryFilter = document.getElementById('resultsFilterCategory').value;
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const answers = allData.filter(item => 
        item.type === 'answers' && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const loading = document.getElementById('resultsLoading');
      const container = document.getElementById('resultsList');

      loading.classList.remove('show');

      // Filtrar alunos por escola e turma
      let filteredStudents = students;
      
      if (schoolFilter || classFilter) {
        const relevantAllocations = allocations.filter(alloc => {
          if (schoolFilter && alloc.school_id !== schoolFilter) return false;
          if (classFilter && alloc.class_id !== classFilter) return false;
          return true;
        });
        
        const relevantStudentIds = relevantAllocations.map(a => a.student_id);
        filteredStudents = students.filter(s => relevantStudentIds.includes(s.__backendId));
      }

      // Mapear respostas e aplicar filtro de categoria
      let studentsWithResults = filteredStudents.map(student => {
        const studentAnswer = answers.find(a => a.student_id === student.id);
        const allocation = allocations.find(a => a.student_id === student.__backendId);
        
        let schoolName = '';
        let className = '';
        
        if (allocation) {
          const school = allData.find(s => s.__backendId === allocation.school_id);
          const cls = allData.find(c => c.__backendId === allocation.class_id);
          schoolName = school?.name || 'Escola n√£o encontrada';
          className = cls?.name || 'Turma n√£o encontrada';
        }
        
        return {
          ...student,
          answer: studentAnswer,
          school: schoolName,
          class: className
        };
      });

      // Filtrar por categoria se selecionada
      if (categoryFilter) {
        studentsWithResults = studentsWithResults.filter(s => s.answer && s.answer.category === categoryFilter);
      }

      // Atualizar estat√≠sticas baseadas nos resultados filtrados
      const studentsWithAnswers = studentsWithResults.filter(s => s.answer);
      
      document.getElementById('totalStudents').textContent = filteredStudents.length;
      document.getElementById('studentsWithAnswers').textContent = studentsWithAnswers.length;
      
      const adequateCount = studentsWithAnswers.filter(s => s.answer.category === 'Adequado').length;
      document.getElementById('excellentCount').textContent = adequateCount;

      if (studentsWithAnswers.length > 0) {
        const averagePercentage = Math.round(studentsWithAnswers.reduce((sum, s) => sum + s.answer.percentage, 0) / studentsWithAnswers.length);
        document.getElementById('averageScore').textContent = `${averagePercentage}%`;
      } else {
        document.getElementById('averageScore').textContent = '0%';
      }

      // Mostrar resultados
      if (studentsWithResults.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum resultado dispon√≠vel com os filtros selecionados.</p>';
        return;
      }

      container.innerHTML = studentsWithResults.map(student => `
        <div class="student-card">
          <div class="student-name">${student.name}</div>
          <div class="student-class">üè´ ${student.school || 'N√£o alocado'}</div>
          <div class="student-class">üìö ${student.class || 'N√£o alocado'}</div>
          ${student.answer ? `
            <div class="student-score ${getCategoryClass(student.answer.category)}">
              ${student.answer.score}/${currentGabarito.length} (${student.answer.percentage}%)
            </div>
            <div class="${getCategoryClass(student.answer.category)}" style="margin-bottom: 15px;">${student.answer.category}</div>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="btn btn-primary btn-small" onclick="editStudentResult('${student.id}')">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger btn-small" onclick="deleteStudentResult('${student.id}')">üóëÔ∏è Excluir</button>
            </div>
          ` : `
            <div style="color: #999; font-style: italic; margin-bottom: 15px;">Ainda n√£o respondeu</div>
            <button class="btn btn-primary btn-small" onclick="editStudentResult('${student.id}')">‚ûï Lan√ßar</button>
          `}
        </div>
      `).join('');
    }

    function updateResults() {
      updateResultsFilters();
      filterResults();
    }

    function updateCharts() {
      if (!currentCoordinatorId) return;
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      const answers = allData.filter(item => 
        item.type === 'answers' && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      
      if (answers.length === 0) {
        clearCharts();
        return;
      }

      updateCategoryChart(answers);
      updateSchoolChart(students, answers);
      updateScoreChart(answers);
    }

    function clearCharts() {
      const charts = ['categoryChart', 'schoolChart', 'scoreChart'];
      charts.forEach(chartId => {
        const canvas = document.getElementById(chartId);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Nenhum dado dispon√≠vel', canvas.width / 2, canvas.height / 2);
      });
    }

    function updateCategoryChart(answers) {
      const canvas = document.getElementById('categoryChart');
      const ctx = canvas.getContext('2d');
      
      const categories = {
        'Adequado': { count: 0, color: '#007bff' },
        'Intermedi√°rio': { count: 0, color: '#ffc107' },
        'Defasagem': { count: 0, color: '#dc3545' }
      };

      answers.forEach(answer => {
        if (categories[answer.category]) {
          categories[answer.category].count++;
        }
      });

      drawBarChart(ctx, canvas, categories, 'Quantidade de Alunos');
    }

    function updateSchoolChart(students, answers) {
      const canvas = document.getElementById('schoolChart');
      const ctx = canvas.getContext('2d');
      
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const schools = allData.filter(item => 
        item.type === 'school' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const schoolData = {};
      
      answers.forEach(answer => {
        const student = students.find(s => s.id === answer.student_id);
        if (student) {
          const allocation = allocations.find(a => a.student_id === student.__backendId);
          if (allocation) {
            const school = schools.find(s => s.__backendId === allocation.school_id);
            if (school) {
              if (!schoolData[school.name]) {
                schoolData[school.name] = { total: 0, sum: 0 };
              }
              schoolData[school.name].total++;
              schoolData[school.name].sum += answer.percentage;
            }
          }
        }
      });

      const schoolAverages = {};
      Object.keys(schoolData).forEach(school => {
        const avg = Math.round(schoolData[school].sum / schoolData[school].total);
        schoolAverages[school] = { 
          count: avg, 
          color: getColorByPercentage(avg) 
        };
      });

      drawBarChart(ctx, canvas, schoolAverages, 'M√©dia (%)');
    }

    function updateScoreChart(answers) {
      const canvas = document.getElementById('scoreChart');
      const ctx = canvas.getContext('2d');
      
      const scoreRanges = {
        '0-25%': { count: 0, color: '#dc3545' },
        '26-50%': { count: 0, color: '#fd7e14' },
        '51-75%': { count: 0, color: '#ffc107' },
        '76-100%': { count: 0, color: '#28a745' }
      };

      answers.forEach(answer => {
        const percentage = answer.percentage;
        if (percentage <= 25) scoreRanges['0-25%'].count++;
        else if (percentage <= 50) scoreRanges['26-50%'].count++;
        else if (percentage <= 75) scoreRanges['51-75%'].count++;
        else scoreRanges['76-100%'].count++;
      });

      drawBarChart(ctx, canvas, scoreRanges, 'Quantidade de Alunos');
    }

    function getColorByPercentage(percentage) {
      if (percentage >= 80) return '#007bff';
      if (percentage >= 50) return '#ffc107';
      return '#dc3545';
    }

    function drawBarChart(ctx, canvas, data, yLabel) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const padding = 60;
      const chartWidth = canvas.width - 2 * padding;
      const chartHeight = canvas.height - 2 * padding;
      
      const labels = Object.keys(data);
      const values = labels.map(label => data[label].count);
      const maxValue = Math.max(...values, 1);
      
      const barWidth = chartWidth / labels.length * 0.8;
      const barSpacing = chartWidth / labels.length * 0.2;
      
      // Desenhar barras
      labels.forEach((label, index) => {
        const value = values[index];
        const barHeight = (value / maxValue) * chartHeight;
        const x = padding + index * (barWidth + barSpacing) + barSpacing / 2;
        const y = canvas.height - padding - barHeight;
        
        ctx.fillStyle = data[label].color;
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Valor no topo da barra
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(value, x + barWidth / 2, y - 5);
        
        // Label no eixo X
        ctx.save();
        ctx.translate(x + barWidth / 2, canvas.height - padding + 15);
        ctx.rotate(-Math.PI / 4);
        ctx.textAlign = 'right';
        ctx.fillText(label, 0, 0);
        ctx.restore();
      });
      
      // Eixo Y
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, canvas.height - padding);
      ctx.stroke();
      
      // Eixo X
      ctx.beginPath();
      ctx.moveTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();
      
      // Label do eixo Y
      ctx.save();
      ctx.translate(20, canvas.height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillStyle = '#666';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();
    }

    function showCelebrationPopup(category, percentage) {
      const overlay = document.createElement('div');
      overlay.className = 'overlay show';
      overlay.style.zIndex = '1998';
      
      const popup = document.createElement('div');
      popup.className = 'celebration-popup';
      
      let emoji, title, message, popupClass;
      
      switch (category) {
        case 'Adequado':
          emoji = 'üéâ';
          title = 'PARAB√âNS!';
          message = `Excelente desempenho! ${percentage}% de acertos!`;
          popupClass = 'success';
          createConfetti();
          break;
        case 'Intermedi√°rio':
          emoji = '‚ö†Ô∏è';
          title = 'ATEN√á√ÉO!';
          message = `Desempenho intermedi√°rio. ${percentage}% de acertos. Continue estudando!`;
          popupClass = 'warning';
          break;
        case 'Defasagem':
          emoji = 'üòû';
          title = 'RUIM!';
          message = `Precisa melhorar. ${percentage}% de acertos. Estude mais!`;
          popupClass = 'danger';
          break;
      }
      
      popup.className += ` ${popupClass}`;
      popup.innerHTML = `
        <div class="celebration-emoji">${emoji}</div>
        <div class="celebration-title">${title}</div>
        <div class="celebration-message">${message}</div>
        <button class="btn btn-primary" onclick="closeCelebrationPopup()">OK</button>
      `;
      
      document.body.appendChild(overlay);
      document.body.appendChild(popup);
      
      // Auto fechar ap√≥s 5 segundos
      setTimeout(() => {
        closeCelebrationPopup();
      }, 5000);
    }

    function createConfetti() {
      const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'];
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 2 + 's';
          document.body.appendChild(confetti);
          
          setTimeout(() => {
            confetti.remove();
          }, 3000);
        }, i * 100);
      }
    }

    function closeCelebrationPopup() {
      const overlay = document.querySelector('.overlay[style*="1998"]');
      const popup = document.querySelector('.celebration-popup');
      
      if (overlay) overlay.remove();
      if (popup) popup.remove();
      
      // Remover confetes
      document.querySelectorAll('.confetti').forEach(confetti => confetti.remove());
    }

    function editStudentResult(studentId) {
      // Ir para a aba de respostas
      showTab('answers');
      document.querySelector('.tab[onclick="showTab(\'answers\')"]').classList.add('active');
      
      // Selecionar o aluno
      document.getElementById('studentSelect').value = studentId;
      
      // Carregar as respostas do aluno
      loadStudentAnswers();
      
      // Mostrar mensagem informativa
      const studentData = allData.find(s => s.type === 'student' && s.id === studentId);
      showMessage(`üéØ Editando respostas de ${studentData?.name || 'aluno'}. Fa√ßa as altera√ß√µes e clique em "Atualizar Respostas".`, 'success');
    }

    function deleteStudentResult(studentId) {
      const studentData = allData.find(s => s.type === 'student' && s.id === studentId);
      const studentName = studentData?.name || 'aluno';
      
      // Criar modal de confirma√ß√£o personalizado (n√£o usar confirm() por causa do iframe)
      const overlay = document.createElement('div');
      overlay.className = 'overlay show';
      overlay.style.zIndex = '1998';
      
      const modal = document.createElement('div');
      modal.className = 'answer-selector';
      modal.style.zIndex = '1999';
      modal.innerHTML = `
        <h3 style="color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è Confirmar Exclus√£o</h3>
        <p style="margin-bottom: 25px; text-align: center; color: #333;">
          Tem certeza que deseja excluir o resultado de <strong>${studentName}</strong>?<br>
          <span style="color: #666; font-size: 14px;">Esta a√ß√£o n√£o pode ser desfeita.</span>
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button class="btn btn-danger" onclick="confirmDeleteResult('${studentId}')">üóëÔ∏è Sim, Excluir</button>
          <button class="btn" onclick="cancelDeleteResult()" style="background: #6c757d; color: white;">‚ùå Cancelar</button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      document.body.appendChild(modal);
    }

    function confirmDeleteResult(studentId) {
      // Encontrar e remover o resultado
      const resultIndex = allData.findIndex(item => 
        item.type === 'answers' && 
        item.student_id === studentId && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      
      if (resultIndex !== -1) {
        const studentData = allData.find(s => s.type === 'student' && s.id === studentId);
        const studentName = studentData?.name || 'aluno';
        
        allData.splice(resultIndex, 1);
        saveAllData();
        
        showMessage(`‚úÖ Resultado de ${studentName} exclu√≠do com sucesso!`, 'success');
        
        // Atualizar todas as visualiza√ß√µes
        updateResults();
        updateLista();
      }
      
      cancelDeleteResult();
    }

    function cancelDeleteResult() {
      const overlay = document.querySelector('.overlay[style*="1998"]');
      const modal = document.querySelector('.answer-selector[style*="1999"]');
      
      if (overlay) overlay.remove();
      if (modal) modal.remove();
    }

    function exportResultsToFile() {
      if (!currentCoordinatorId) return;
      
      const schoolFilter = document.getElementById('resultsFilterSchool').value;
      const classFilter = document.getElementById('resultsFilterClass').value;
      const categoryFilter = document.getElementById('resultsFilterCategory').value;
      
      const students = allData.filter(item => 
        item.type === 'student' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      const answers = allData.filter(item => 
        item.type === 'answers' && 
        item.coordinator_id === currentCoordinatorId && 
        item.month === currentMonth
      );
      
      const allocations = allData.filter(item => 
        item.type === 'allocation' && 
        item.coordinator_id === currentCoordinatorId
      );
      
      // Filtrar alunos por escola e turma
      let filteredStudents = students;
      
      if (schoolFilter || classFilter) {
        const relevantAllocations = allocations.filter(alloc => {
          if (schoolFilter && alloc.school_id !== schoolFilter) return false;
          if (classFilter && alloc.class_id !== classFilter) return false;
          return true;
        });
        
        const relevantStudentIds = relevantAllocations.map(a => a.student_id);
        filteredStudents = students.filter(s => relevantStudentIds.includes(s.__backendId));
      }

      // Mapear respostas e aplicar filtro de categoria
      let studentsWithResults = filteredStudents.map(student => {
        const studentAnswer = answers.find(a => a.student_id === student.id);
        const allocation = allocations.find(a => a.student_id === student.__backendId);
        
        let schoolName = '';
        let className = '';
        
        if (allocation) {
          const school = allData.find(s => s.__backendId === allocation.school_id);
          const cls = allData.find(c => c.__backendId === allocation.class_id);
          schoolName = school?.name || 'Escola n√£o encontrada';
          className = cls?.name || 'Turma n√£o encontrada';
        }
        
        return {
          ...student,
          answer: studentAnswer,
          school: schoolName,
          class: className
        };
      }).filter(s => s.answer); // S√≥ exportar quem tem resultado

      // Filtrar por categoria se selecionada
      if (categoryFilter) {
        studentsWithResults = studentsWithResults.filter(s => s.answer.category === categoryFilter);
      }

      if (studentsWithResults.length === 0) {
        showMessage('Nenhum resultado dispon√≠vel para exportar com os filtros selecionados!', 'error');
        return;
      }

      // Ordenar por escola, turma e nome
      studentsWithResults.sort((a, b) => {
        if (a.school !== b.school) return a.school.localeCompare(b.school);
        if (a.class !== b.class) return a.class.localeCompare(b.class);
        return a.name.localeCompare(b.name);
      });

      // Estat√≠sticas gerais
      const adequateCount = studentsWithResults.filter(s => s.answer.category === 'Adequado').length;
      const intermediateCount = studentsWithResults.filter(s => s.answer.category === 'Intermedi√°rio').length;
      const defasagemCount = studentsWithResults.filter(s => s.answer.category === 'Defasagem').length;
      const averagePercentage = Math.round(studentsWithResults.reduce((sum, s) => sum + s.answer.percentage, 0) / studentsWithResults.length);
      
      // Agrupar por escola e turma
      const groupedResults = {};
      studentsWithResults.forEach(student => {
        const key = `${student.school} - ${student.class}`;
        if (!groupedResults[key]) {
          groupedResults[key] = [];
        }
        groupedResults[key].push(student);
      });
      
      // Gerar PDF usando jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPosition = 20;
      const pageHeight = doc.internal.pageSize.height;
      const marginBottom = 20;
      
      // Fun√ß√£o para adicionar nova p√°gina se necess√°rio
      function checkPageBreak(neededSpace) {
        if (yPosition + neededSpace > pageHeight - marginBottom) {
          doc.addPage();
          yPosition = 20;
          return true;
        }
        return false;
      }
      
      // Cabe√ßalho
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text('RELAT√ìRIO DE RESULTADOS DO SIMULADO', 105, yPosition, { align: 'center' });
      yPosition += 10;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`M√™s: ${currentMonth}`, 20, yPosition);
      yPosition += 6;
      doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 20, yPosition);
      yPosition += 6;
      doc.text(`Coordenadora: ${coordinatorNames[currentCoordinatorId]}`, 20, yPosition);
      yPosition += 10;
      
      // Filtros aplicados
      if (schoolFilter) {
        const school = allData.find(s => s.__backendId === schoolFilter);
        doc.text(`Escola: ${school?.name || 'Todas'}`, 20, yPosition);
        yPosition += 6;
      }
      if (classFilter) {
        const cls = allData.find(c => c.__backendId === classFilter);
        doc.text(`Turma: ${cls?.name || 'Todas'}`, 20, yPosition);
        yPosition += 6;
      }
      if (categoryFilter) {
        doc.text(`Categoria: ${categoryFilter}`, 20, yPosition);
        yPosition += 6;
      }
      
      yPosition += 5;
      
      // Estat√≠sticas gerais
      checkPageBreak(40);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('ESTAT√çSTICAS GERAIS', 20, yPosition);
      yPosition += 8;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Total de Alunos: ${studentsWithResults.length}`, 20, yPosition);
      yPosition += 6;
      doc.text(`M√©dia Geral: ${averagePercentage}%`, 20, yPosition);
      yPosition += 8;
      
      doc.text(`Adequado: ${adequateCount} alunos (${Math.round(adequateCount/studentsWithResults.length*100)}%)`, 20, yPosition);
      yPosition += 6;
      doc.text(`Intermedi√°rio: ${intermediateCount} alunos (${Math.round(intermediateCount/studentsWithResults.length*100)}%)`, 20, yPosition);
      yPosition += 6;
      doc.text(`Defasagem: ${defasagemCount} alunos (${Math.round(defasagemCount/studentsWithResults.length*100)}%)`, 20, yPosition);
      yPosition += 12;
      
      // Listar resultados por grupo
      Object.keys(groupedResults).sort().forEach(groupKey => {
        const groupStudents = groupedResults[groupKey];
        
        checkPageBreak(50);
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`${groupKey} (${groupStudents.length} alunos)`, 20, yPosition);
        yPosition += 8;
        
        // Cabe√ßalho da tabela
        doc.setFontSize(9);
        doc.text('N¬∫', 20, yPosition);
        doc.text('Nome do Aluno', 30, yPosition);
        doc.text('Acertos', 110, yPosition);
        doc.text('Nota', 140, yPosition);
        doc.text('N√≠vel', 165, yPosition);
        yPosition += 5;
        
        doc.setFont(undefined, 'normal');
        
        groupStudents.forEach((student, index) => {
          checkPageBreak(8);
          
          const number = String(index + 1);
          const name = student.name.substring(0, 30);
          const score = `${student.answer.score}/${currentGabarito.length}`;
          const percentage = `${student.answer.percentage}%`;
          const category = student.answer.category;
          
          doc.text(number, 20, yPosition);
          doc.text(name, 30, yPosition);
          doc.text(score, 110, yPosition);
          doc.text(percentage, 140, yPosition);
          doc.text(category, 165, yPosition);
          yPosition += 6;
        });
        
        yPosition += 8;
      });
      
      // Nome do arquivo baseado nos filtros
      let fileName = `Resultados_${currentMonth}`;
      if (schoolFilter) {
        const school = allData.find(s => s.__backendId === schoolFilter);
        fileName += `_${school?.name.replace(/\s+/g, '_')}`;
      }
      if (classFilter) {
        const cls = allData.find(c => c.__backendId === classFilter);
        fileName += `_${cls?.name.replace(/\s+/g, '_')}`;
      }
      if (categoryFilter) {
        fileName += `_${categoryFilter}`;
      }
      fileName += '.pdf';
      
      // Salvar PDF
      doc.save(fileName);
      
      showMessage(`‚úÖ Arquivo "${fileName}" gerado com sucesso! ${studentsWithResults.length} alunos exportados.`, 'success');
    }

    function showMessage(text, type) {
      const container = document.getElementById('messages');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      container.appendChild(message);

      setTimeout(() => {
        message.remove();
      }, 5000);
    }

    // Inicializar aplica√ß√£o
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99d64a779397ba1a',t:'MTc2Mjk1MzI1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
